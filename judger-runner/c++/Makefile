# é…ç½®é©…å‹• OJ å¾®æœå‹™ C++ ç‰ˆæœ¬ Makefile

# è®Šæ•¸å®šç¾©
CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -O2 -g
HARNESS = harness
CONFIG = config.json
RESULT = result.json

# é»˜èªç›®æ¨™
.PHONY: all build test clean help examples test-all

all: build

# ç·¨è­¯ harness
build: $(HARNESS)

$(HARNESS): harness.cpp json.hpp
	@echo "ç·¨è­¯ C++ harness..."
	$(CXX) $(CXXFLAGS) harness.cpp -o $(HARNESS)
	@echo "âœ… ç·¨è­¯å®Œæˆ"

# é‹è¡Œæ¸¬è©¦
test: build
	@echo "é‹è¡ŒåŸºæœ¬æ¸¬è©¦..."
	./$(HARNESS) $(CONFIG) $(RESULT)
	@echo "æ¸¬è©¦å®Œæˆï¼Œçµæœä¿å­˜åœ¨ $(RESULT)"

# é‹è¡Œæ¸¬è©¦ä¸¦é¡¯ç¤ºè©³ç´°éŒ¯èª¤ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
test-verbose: build
	@echo "é‹è¡Œæ¸¬è©¦ï¼ˆè©³ç´°æ¨¡å¼ï¼‰..."
	./$(HARNESS) $(CONFIG) $(RESULT)
	@echo "æ¸¬è©¦å®Œæˆï¼Œçµæœä¿å­˜åœ¨ $(RESULT)"
	@if [ -f $(RESULT) ]; then \
		echo "=== æ¸¬è©¦çµæœ ==="; \
		cat $(RESULT); \
		echo ""; \
	fi

# é¡¯ç¤ºçµæœ
show-result:
	@if [ -f $(RESULT) ]; then \
		echo "=== æ¸¬è©¦çµæœ ==="; \
		cat $(RESULT); \
	else \
		echo "âŒ çµæœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè«‹å…ˆé‹è¡Œæ¸¬è©¦"; \
	fi

# é‹è¡Œæ‰€æœ‰ç¤ºä¾‹
test-all: build
	@echo "ğŸ§ª é‹è¡Œæ‰€æœ‰ç¤ºä¾‹æ¸¬è©¦..."
	@echo ""
	@echo "1ï¸âƒ£ åŸºæœ¬æ•¸å­¸é‹ç®—æ¸¬è©¦"
	@echo "========================"
	@if [ -f user_basic.cpp ]; then \
		cp user_basic.cpp user.cpp; \
	fi
	./$(HARNESS) config.json result_basic.json
	@cat result_basic.json
	@echo ""
	@echo ""
	@echo "2ï¸âƒ£ å­—ç¬¦ä¸²è™•ç†æ¸¬è©¦"
	@echo "======================="
	@if [ -f user_string.cpp ]; then \
		cp user_string.cpp user.cpp; \
		./$(HARNESS) config_string.json result_string.json; \
		cat result_string.json; \
	fi
	@echo ""
	@echo ""
	@echo "3ï¸âƒ£ å®¹å™¨æ“ä½œæ¸¬è©¦"
	@echo "====================="
	@if [ -f user_vector.cpp ]; then \
		cp user_vector.cpp user.cpp; \
		./$(HARNESS) config_vector.json result_vector.json; \
		cat result_vector.json; \
	fi
	@echo ""
	@echo ""
	@echo "4ï¸âƒ£ éšä¹˜è¨ˆç®—æ¸¬è©¦"
	@echo "====================="
	@if [ -f user_factorial.cpp ]; then \
		cp user_factorial.cpp user.cpp; \
		./$(HARNESS) config_factorial.json result_factorial.json; \
		cat result_factorial.json; \
	fi
	@echo ""
	@echo "âœ… æ‰€æœ‰æ¸¬è©¦å®Œæˆ"

# æ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶
clean:
	@echo "æ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶..."
	rm -f $(HARNESS)
	rm -f test_main.cpp
	rm -f test_runner
	rm -f result*.json
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æ·±åº¦æ¸…ç†ï¼ˆåŒ…æ‹¬ç”¨æˆ¶ä»£ç¢¼å‚™ä»½ï¼‰
clean-all: clean
	@echo "æ·±åº¦æ¸…ç†..."
	rm -f user_backup.cpp
	rm -f *.o
	@echo "âœ… æ·±åº¦æ¸…ç†å®Œæˆ"

# é¡¯ç¤ºå¹«åŠ©ä¿¡æ¯
help:
	@echo "é…ç½®é©…å‹• OJ å¾®æœå‹™ C++ ç‰ˆæœ¬"
	@echo ""
	@echo "å¯ç”¨çš„å‘½ä»¤ï¼š"
	@echo "  make build        - ç·¨è­¯ harness"
	@echo "  make test         - é‹è¡ŒåŸºæœ¬æ¸¬è©¦"
	@echo "  make test-verbose - é‹è¡Œè©³ç´°æ¸¬è©¦"
	@echo "  make test-all     - é‹è¡Œæ‰€æœ‰ç¤ºä¾‹æ¸¬è©¦"
	@echo "  make show-result  - é¡¯ç¤ºæ¸¬è©¦çµæœ"
	@echo "  make clean        - æ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶"
	@echo "  make clean-all    - æ·±åº¦æ¸…ç†"
	@echo "  make help         - é¡¯ç¤ºæ­¤å¹«åŠ©ä¿¡æ¯"
	@echo ""
	@echo "ç¤ºä¾‹ç”¨æ³•ï¼š"
	@echo "  make build                           # ç·¨è­¯"
	@echo "  make test                           # é‹è¡Œé»˜èªæ¸¬è©¦"
	@echo "  make CONFIG=config_string.json test # ä½¿ç”¨æŒ‡å®šé…ç½®æ¸¬è©¦"
	@echo ""
	@echo "é…ç½®æ–‡ä»¶ï¼š"
	@echo "  config.json           - åŸºæœ¬æ•¸å­¸é‹ç®—"
	@echo "  config_string.json    - å­—ç¬¦ä¸²è™•ç†"
	@echo "  config_vector.json    - å®¹å™¨æ“ä½œ"
	@echo "  config_factorial.json - éšä¹˜è¨ˆç®—"

# å‰µå»ºç¤ºä¾‹é…ç½®
examples:
	@echo "ğŸ“ å¯ç”¨çš„ç¤ºä¾‹é…ç½®æ–‡ä»¶ï¼š"
	@echo ""
	@if [ -f config.json ]; then \
		echo "âœ… config.json - åŸºæœ¬æ•¸å­¸é‹ç®—"; \
		echo "   è¼¸å…¥: a=3, b=4"; \
		echo "   æœŸæœ›: a=6, b=9"; \
		echo ""; \
	fi
	@if [ -f config_string.json ]; then \
		echo "âœ… config_string.json - å­—ç¬¦ä¸²è™•ç†"; \
		echo "   è¼¸å…¥: text=\"hello\", length=0"; \
		echo "   æœŸæœ›: text=\"HELLO\", length=5"; \
		echo ""; \
	fi
	@if [ -f config_vector.json ]; then \
		echo "âœ… config_vector.json - å®¹å™¨æ“ä½œ"; \
		echo "   è¼¸å…¥: numbers=[1,2,3,4,5], sum=0"; \
		echo "   æœŸæœ›: numbers=[2,4,6,8,10], sum=30"; \
		echo ""; \
	fi
	@if [ -f config_factorial.json ]; then \
		echo "âœ… config_factorial.json - éšä¹˜è¨ˆç®—"; \
		echo "   è¼¸å…¥: n=5, result=1"; \
		echo "   æœŸæœ›: n=5, result=120"; \
		echo ""; \
	fi
	@echo "ğŸ’¡ ä½¿ç”¨ 'make CONFIG=<é…ç½®æ–‡ä»¶> test' é‹è¡ŒæŒ‡å®šé…ç½®çš„æ¸¬è©¦"

# æª¢æŸ¥ç·¨è­¯ç’°å¢ƒ
check-env:
	@echo "ğŸ” æª¢æŸ¥ç·¨è­¯ç’°å¢ƒ..."
	@echo ""
	@echo "C++ ç·¨è­¯å™¨:"
	@$(CXX) --version || echo "âŒ C++ ç·¨è­¯å™¨æœªæ‰¾åˆ°"
	@echo ""
	@echo "C++17 æ”¯æŒæ¸¬è©¦:"
	@echo 'int main() { auto x = 42; return 0; }' | $(CXX) -std=c++17 -x c++ - -o /tmp/cpp17_test 2>/dev/null && echo "âœ… C++17 æ”¯æŒæ­£å¸¸" || echo "âŒ C++17 æ”¯æŒæœ‰å•é¡Œ"
	@rm -f /tmp/cpp17_test
	@echo ""
	@echo "ç·¨è­¯æ¨™èªŒ: $(CXXFLAGS)"

# å¿«é€Ÿæ¸¬è©¦ï¼ˆç”¨æ–¼é–‹ç™¼ï¼‰
quick-test: build
	@echo "âš¡ å¿«é€Ÿæ¸¬è©¦..."
	./$(HARNESS) $(CONFIG) $(RESULT) && echo "âœ… æ¸¬è©¦é€šé" || echo "âŒ æ¸¬è©¦å¤±æ•—"

# æ€§èƒ½æ¸¬è©¦
benchmark: build
	@echo "ğŸƒâ€â™‚ï¸ æ€§èƒ½æ¸¬è©¦..."
	@for i in {1..5}; do \
		echo "ç¬¬ $$i æ¬¡é‹è¡Œ:"; \
		time ./$(HARNESS) $(CONFIG) $(RESULT); \
		echo ""; \
	done

# èª¿è©¦æ¨¡å¼ç·¨è­¯
debug: CXXFLAGS += -DDEBUG -O0
debug: build
	@echo "ğŸ› èª¿è©¦ç‰ˆæœ¬ç·¨è­¯å®Œæˆ"

# ç™¼ä½ˆæ¨¡å¼ç·¨è­¯
release: CXXFLAGS += -DNDEBUG -O3
release: build
	@echo "ğŸš€ ç™¼ä½ˆç‰ˆæœ¬ç·¨è­¯å®Œæˆ"
